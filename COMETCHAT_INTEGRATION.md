# CometChat Integration Guide

This document provides a comprehensive guide on how to set up and use the CometChat integration in MuseAI.

## Features

The CometChat integration adds the following features to MuseAI:

### 1. **Real-time Group Chat**
- Create public group chatrooms
- Join existing chatrooms
- Real-time messaging between users
- Automatic message synchronization

### 2. **AI Integration with Commands**
- Use `/` or `\` prefix to chat with AI
- Messages with these prefixes are processed by Gemini AI
- Regular messages go to the group chat
- AI responses are clearly marked

### 3. **User Management**
- Automatic user creation in CometChat using phone number as UID
- Secure authentication using CometChat Auth Keys
- Proper logout handling

## Setup Instructions

### Step 1: Create CometChat Account

1. Go to [CometChat Dashboard](https://app.cometchat.com/)
2. Sign up for a free account
3. Create a new app
4. Note down your:
   - App ID
   - Region
   - Auth Key

### Step 2: Configure Environment Variables

Add the following variables to your `.env.local` file:

```bash
NEXT_PUBLIC_COMETCHAT_APP_ID='your_app_id_here'
NEXT_PUBLIC_COMETCHAT_REGION='your_region_here'  # e.g., 'us' or 'eu'
NEXT_PUBLIC_COMETCHAT_AUTH_KEY='your_auth_key_here'
```

### Step 3: Test the Integration

1. Start your application: `npm run dev`
2. Complete the phone authentication
3. Create a new chatroom
4. Invite friends to join using the same chatroom name
5. Test both regular messages and AI commands

## How It Works

### Architecture Overview

```
MuseAI App
├── Authentication (Phone + OTP)
├── CometChat Integration
│   ├── User Creation/Login
│   ├── Group Management
│   └── Real-time Messaging
├── AI Processing (Gemini)
└── Local State Management (Zustand)
```

### Message Flow

1. **Regular Group Messages:**
   ```
   User types message → Local state → CometChat → Other users
   ```

2. **AI Commands:**
   ```
   User types /message → Local state → Gemini AI → AI response (local only)
   ```

### Data Models

#### User
```typescript
{
  uid: string,        // Phone number (e.g., "+1234567890")
  name: string        // Display name
}
```

#### Group
```typescript
{
  guid: string,       // Unique group identifier
  name: string,       // Group name
  type: "PUBLIC"      // All groups are public for easy joining
}
```

#### Message
```typescript
{
  id: string,         // Unique message ID
  content: string,    // Message text
  sender: 'user' | 'ai',
  timestamp: Date,
  senderName?: string,
  isAICommand?: boolean
}
```

## Usage Guide

### Creating a Chatroom

1. Click the "+" button in the sidebar
2. Enter a chatroom name
3. The app will:
   - Create a local chatroom
   - Create a CometChat group
   - Join you to the group automatically

### Joining an Existing Chatroom

Currently, users need to create chatrooms with the same name to join. Future versions will include:
- Public chatroom discovery
- Invite links
- QR code sharing

### Using AI Commands

1. Type `/` or `\` followed by your message
2. Examples:
   - `/explain quantum physics`
   - `\write a poem about coding`
   - `/help me debug this code`
3. AI responses appear only in your local chat
4. Other users won't see AI commands or responses

### Group Messaging

1. Type regular messages (without `/` or `\`)
2. Messages are sent to all group members
3. Real-time delivery and read receipts
4. Message history synchronization

## Technical Implementation

### Key Components

#### CometChatManager (`src/lib/cometchat.ts`)
- Singleton class managing CometChat SDK
- Handles initialization, authentication, and messaging
- Provides clean API for the rest of the app

#### Enhanced ChatStore (`src/stores/chatStore.ts`)
- Integrates CometChat with local state
- Manages message routing (AI vs group)
- Handles real-time message listeners

#### Updated UI Components
- **MessageBubble**: Different styling for AI commands and group messages
- **MessageInput**: Shows hint about AI commands
- **AuthPage**: Initializes CometChat on load
- **OTPForm**: Logs user into CometChat after verification

### Security Considerations

1. **Auth Key Usage**: Currently using Auth Key for simplicity. For production, consider:
   - Using Auth Tokens generated by your backend
   - Implementing proper user authentication flow

2. **User Data**: Phone numbers are used as UIDs in CometChat
   - Ensure compliance with privacy regulations
   - Consider hashing or encoding sensitive data

3. **Message Encryption**: CometChat provides:
   - TLS encryption in transit
   - Optional end-to-end encryption (premium feature)

## Troubleshooting

### Common Issues

1. **CometChat not initializing**
   - Check your environment variables
   - Verify App ID and Region are correct
   - Check browser console for errors

2. **User login fails**
   - Ensure Auth Key is valid
   - Check if user creation succeeded
   - Verify phone number format

3. **Messages not syncing**
   - Check internet connection
   - Verify group membership
   - Check CometChat dashboard for errors

### Debug Mode

Enable debug logging by adding to your browser console:
```javascript
localStorage.setItem('debug', 'cometchat*')
```

## Future Enhancements

### Planned Features

1. **Private Messaging**
   - One-on-one chat between users
   - User discovery and friend requests

2. **Enhanced Group Management**
   - Admin controls
   - Member management
   - Group settings

3. **Media Sharing**
   - Image/file sharing in groups
   - Voice messages
   - Video calls integration

4. **AI Improvements**
   - Context-aware AI responses
   - Shared AI conversations in groups
   - AI moderation features

### Performance Optimizations

1. **Message Pagination**
   - Load older messages on demand
   - Implement virtual scrolling for large chat histories

2. **Offline Support**
   - Cache messages locally
   - Sync when connection restored

3. **Real-time Optimizations**
   - Message batching
   - Connection pooling
   - Smart reconnection logic

## API Reference

### CometChatManager Methods

```typescript
// Initialize CometChat
await manager.initialize(): Promise<boolean>

// User management
await manager.createUser(uid: string, name: string): Promise<User>
await manager.loginUser(uid: string): Promise<User>
await manager.logoutUser(): Promise<boolean>

// Group management
await manager.createGroup(guid: string, name: string): Promise<Group>
await manager.joinGroup(guid: string): Promise<Group>

// Messaging
await manager.sendTextMessage(receiverId: string, text: string): Promise<BaseMessage>
await manager.getGroupMessages(guid: string, limit?: number): Promise<BaseMessage[]>

// Listeners
manager.setupMessageListener(id: string, callback: Function): void
manager.removeMessageListener(id: string): void
```

### ChatStore Methods

```typescript
// CometChat integration
await initializeCometChat(): Promise<boolean>
await loginToCometChat(phoneNumber: string, name?: string): Promise<boolean>
await logoutFromCometChat(): Promise<void>

// Group chat
await createChatroom(title: string, isGroupChat?: boolean): Promise<Chatroom>
await joinChatroom(chatroomId: string): Promise<boolean>
await sendMessage(content: string, image?: string): Promise<void>
```

## Support

For issues related to:
- **CometChat SDK**: Check [CometChat Documentation](https://www.cometchat.com/docs/)
- **MuseAI Integration**: Create an issue in the repository
- **Gemini AI**: Check [Google AI Documentation](https://ai.google.dev/)

## License

This integration follows the same license as the main MuseAI project.
